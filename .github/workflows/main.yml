name: Build and Deploy Backend

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        run: |
          mvn clean package -DskipTests
      
      - name: Verify jar file exists
        run: |
          if [ ! -f target/sehub.jar ]; then
            echo "‚ùå Error: JAR file not found!"
            exit 1
          fi
          echo "‚úÖ JAR file found: $(ls -lh target/sehub.jar)"
      
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
      
      - name: Cleanup old files on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            echo "üßπ Cleaning up old files..."
            sudo rm -rf /tmp/app.jar /tmp/target /tmp/sehub.jar
            echo "‚úÖ Cleanup completed"
      
      - name: Upload jar file to server
        run: |
          echo "üì§ Uploading JAR file to server..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            -P 22 \
            target/sehub.jar \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/tmp/app.jar
          
          echo "‚úÖ Upload completed"
      
      - name: Verify and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            set -e
            
            echo "üîç Verifying uploaded file..."
            if [ ! -f /tmp/app.jar ]; then
              echo "‚ùå Error: /tmp/app.jar not found!"
              exit 1
            fi
            
            if [ ! -s /tmp/app.jar ]; then
              echo "‚ùå Error: /tmp/app.jar is empty!"
              exit 1
            fi
            
            echo "‚úÖ File verified: $(ls -lh /tmp/app.jar)"
            echo "üìã File type: $(file /tmp/app.jar)"
            echo "üìã MD5: $(md5sum /tmp/app.jar | awk '{print $1}')"
            
            echo "üìÇ Copying to deployment location..."
            sudo cp /tmp/app.jar /opt/sehub/app.jar
            sudo chown root:root /opt/sehub/app.jar
            sudo chmod 644 /opt/sehub/app.jar
            
            echo "üìù Checking and copying .env file..."
            # Check if .env exists in source location
            if [ -f /var/www/SE-HUB-BE/.env ]; then
              echo "‚úÖ Found .env file at /var/www/SE-HUB-BE/.env"
              # Copy .env to deployment location
              sudo cp /var/www/SE-HUB-BE/.env /opt/sehub/.env
              sudo chown root:root /opt/sehub/.env
              sudo chmod 600 /opt/sehub/.env
              echo "‚úÖ .env file copied to /opt/sehub/.env"
              
              # Verify required environment variables
              echo "üîç Verifying required environment variables..."
              required_vars=("FTES_API_BASE_URL" "SERVER_PORT" "DB_URL" "DB_USERNAME" "DB_PASSWORD" "ADMIN_USER_NAME" "FTES_JWT_SECRET")
              missing_vars=()
              
              for var in "${required_vars[@]}"; do
                if ! grep -q "^${var}=" /opt/sehub/.env; then
                  missing_vars+=("$var")
                fi
              done
              
              if [ ${#missing_vars[@]} -gt 0 ]; then
                echo "‚ö†Ô∏è  Warning: Missing environment variables in .env file:"
                printf '   - %s\n' "${missing_vars[@]}"
                echo "üí° Please add these variables to /opt/sehub/.env"
              else
                echo "‚úÖ All required environment variables are present"
              fi
            elif [ -f /opt/sehub/.env ]; then
              echo "‚úÖ .env file already exists at /opt/sehub/.env"
            else
              echo "‚ö†Ô∏è  Warning: .env file not found at /var/www/SE-HUB-BE/.env or /opt/sehub/.env"
              echo "üí° Spring Boot will use environment variables or system properties instead"
              echo "‚ö†Ô∏è  Make sure all required environment variables are set in systemd service or system environment"
            fi
            
            echo "‚úÖ Verifying deployment file..."
            if [ ! -f /opt/sehub/app.jar ]; then
              echo "‚ùå Error: /opt/sehub/app.jar not found!"
              exit 1
            fi
            
            echo "üìã Deployed file MD5: $(md5sum /opt/sehub/app.jar | awk '{print $1}')"
            
            echo "üîÑ Restarting service..."
            sudo systemctl restart sehub
            
            sleep 5
            
            echo "üìä Service status:"
            sudo systemctl status sehub --no-pager | head -10
            
            if sudo systemctl is-active --quiet sehub; then
              echo "‚úÖ Deployment completed successfully!"
            else
              echo "‚ùå Error: Service is not running!"
              sudo systemctl status sehub --no-pager
              exit 1
            fi
